<div class="p-6">
  <!-- Form Ubah Data -->
  <div
    id="formUbahData"
    class="bg-teal-600 p-6 rounded-lg shadow-lg max-w mx-auto text-white"
  >
    <h2 class="text-lg font-semibold mb-6 text-center">
      Ubah Data Transaksi Pembelian
    </h2>
    <form id="formUbahTransaksi" action="/transaksi_penjualan/<%= data.penjualan_id %>" method="post">
      <div class="grid grid-cols-3 gap-4 mb-4">
        <label for="nota" class="col-span-1">No. Nota :</label>
        <input
          type="text"
          id="nota"
          value="<%= data.nota %>"
          name="nota"
          class="col-span-2 bg-teal-500 px-4 py-2 rounded-md text-black focus:outline-none"
        />
      </div>

      <div class="grid grid-cols-3 gap-4 mb-4">
        <label for="kode" class="col-span-1">Kode Akun :</label>
        <div class="m-1.5">
          <div>
          <select id="kode" class="bg-teal-600 form-select border border-gray-300 rounded-md shadow-sm">
              <option class="bg-teal-600 p-6 rounded-lg shadow-lg max-w mx-auto text-slate-700">- Kode -</option>
              <% ListAkun.forEach(kode => { %>
              <option class="bg-teal-600 p-6 rounded-lg shadow-lg max-w mx-auto text-slate-700" value="<%= kode.akun_id %>"><%= kode.kode %></option>
              <% }) %>
          </select>
          </div>
      </div>
      </div>

      <div class="grid grid-cols-3 gap-4 mb-4">
        <label for="nama_barang" class="col-span-1">Nama Barang :</label>
        <input
          type="text"
          id="nama_barang"
          value="<%= data.nama_barang %>"
          name="nama_barang"
          class="col-span-2 bg-teal-500 px-4 py-2 rounded-md text-black focus:outline-none"
        />
      </div>

      <div class="grid grid-cols-3 gap-4 mb-4">
        <label for="harga" class="col-span-1">Harga :</label>
        <input
          type="text"
          id="harga"
          value="<%= data.harga %>"
          name="harga"
          class="col-span-2 bg-teal-500 px-4 py-2 rounded-md text-black focus:outline-none"
        />
      </div>

      <div class="grid grid-cols-3 gap-4 mb-4">
        <label for="qty" class="col-span-1">Qty :</label>
        <input
          type="text"
          id="qty"
          value="<%= data.qty %>"
          name="qty"
          class="col-span-2 bg-teal-500 px-4 py-2 rounded-md text-black focus:outline-none"
        />
      </div>

      <div class="grid grid-cols-3 gap-4 mb-4">
        <label for="subtotal" class="col-span-1">Sub Total :</label>
        <input
          type="text"
          id="subtotal"
          value="<%= data.total_pembelian %>"
          name="total_pembelian_display"
          class="col-span-2 bg-teal-500 px-4 py-2 rounded-md text-black focus:outline-none"
          readonly
        />
        <input
          type="hidden"
          id="total_pembelian"
          name="total_pembelian"
          value="<%= data.total_pembelian %>"
        />
      </div>

       <div class="grid grid-cols-3 gap-4 mb-4">
        <label for="kembali" class="col-span-1">Kembalian :</label>
        <input type="text" id="kembali"
        value="<%= data.kembali %>"
        name="kembali_display" class="col-span-2 bg-teal-500 px-4 py-2 rounded-md text-black focus:outline-none" readonly />
        <input type="hidden" id="kembali_raw" value="<%= data.kembali %>" name="kembali" />
      </div>


      <div class="grid grid-cols-3 gap-4 mb-4">
        <label for="total_bayar" class="col-span-1">Total Bayar :</label>
        <input
          type="text"
          id="total_bayar"
          value="<%= data.total_bayar %>"
          name="total_bayar"
          class="col-span-2 bg-teal-500 px-4 py-2 rounded-md text-black focus:outline-none"
        />
      </div>

      <!-- Tombol Aksi -->
      <div class="flex justify-between mt-6">
        <a
          type="button"
          id="batalBtn"
          class="bg-white text-black px-6 py-2 rounded-full"
          href="/transaksi_penjualan"
        >
          Batal
        </a>
        <button
          type="submit"
          class="bg-black text-black-600 px-6 py-2 rounded-full"
        >
          Simpan
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function calculateSubtotal() {
    const harga = parseFloat(document.getElementById("harga").value) || 0;
    const qty = parseInt(document.getElementById("qty").value) || 0;
    const subtotal = harga * qty;

    // Format subtotal as Rupiah for display
    const subtotalFormatted = subtotal.toLocaleString('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0
    });

    // Update the displayed subtotal
    document.getElementById("subtotal").value = subtotalFormatted;

    // Save the raw subtotal value in the hidden input field (without formatting)
    document.getElementById("total_pembelian").value = subtotal;
  }

  // Event listeners for changes in harga and qty
  document.getElementById("harga").addEventListener("input", calculateSubtotal);
  document.getElementById("qty").addEventListener("input", calculateSubtotal);

  function calculateKembalian() {
    const totalBayar = parseFloat(document.getElementById("total_bayar").value.replace(/[^0-9.-]+/g,"")) || 0; // Removing formatting
    const totalPembelian = parseFloat(document.getElementById("total_pembelian").value) || 0;
    const kembalian = totalBayar - totalPembelian;

    // Format kembalian as Rupiah for display
    const kembalianFormatted = kembalian.toLocaleString('id-ID', {
      style: 'currency',
      currency: 'IDR',
      minimumFractionDigits: 0
    });

    // Update the displayed kembalian
    document.getElementById("kembali").value = kembalianFormatted;
    
    // Save the raw kembalian value in the hidden input field (without formatting)
    document.getElementById("kembali_raw").value = kembalian;
  }

  // SweetAlert2 confirmation on form submit
  document
    .getElementById("formUbahTransaksi")
    .addEventListener("submit", function (event) {
      event.preventDefault(); // Mencegah form langsung submit

      Swal.fire({
        title: "Konfirmasi",
        text: "Apakah kamu yakin ingin mengubah data transaksi ini?",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Ya, ubah!",
        cancelButtonText: "Batal",
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
      }).then((result) => {
        if (result.isConfirmed) {
          // Jika dikonfirmasi, lanjutkan submit form
          this.submit();
        }
      });
    });
</script>
